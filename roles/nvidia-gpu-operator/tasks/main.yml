---
# https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/latest/getting-started.html

- name: Wait for port 6443
  wait_for:
    port: 6443

- name: Create gpu-operator namespace
  shell: |
    kubectl create ns gpu-operator
    kubectl label --overwrite ns gpu-operator pod-security.kubernetes.io/enforce=privileged
  retries: 5
  delay: 60

- name: Check for Node Feature Discovery
  shell: >
    kubectl get nodes -o json | jq '.items[].metadata.labels | keys | any(startswith("feature.node.kubernetes.io"))'
  register: nfd_check_result

- name: Set enable_nfd fact
  set_fact:
    enable_nfd: true
  when: "'true' not in nfd_check_result.stdout"

- name: Print enable_nfd
  debug:
    msg: "Enable NFD: {{ enable_nfd }}"

- name: Copy time-slicing-config-all.yaml
  template:
    src: time-slicing-config-all.yaml.j2
    dest: ~/time-slicing-config-all.yaml
  when: enable_time_slicing

- name: Apply time-slicing config map
  shell: >
    kubectl apply -f time-slicing-config-all.yaml
  when: enable_time_slicing

- name: Add nvidia helm repo
  kubernetes.core.helm_repository:
    name: nvidia
    repo_url: https://helm.ngc.nvidia.com/nvidia

- name: Install NVIDIA GPU Operator
  kubernetes.core.helm:
    name: gpu-operator
    chart_ref: nvidia/gpu-operator
    chart_version: "{{ gpu_operator_chart_version | default('25.3.0') }}"
    release_namespace: "{{ gpu_operator_release }}"
    create_namespace: true
    values:
      driver:
        enabled: false
      nfd:
        enabled: "{{ enable_nfd }}"
      toolkit:
        env:
          - name: CONTAINERD_CONFIG
            value: /var/lib/rancher/rke2/agent/etc/containerd/config.toml.tmpl
          - name: CONTAINERD_SOCKET
            value: /run/k3s/containerd/containerd.sock
          - name: CONTAINERD_RUNTIME_CLASS
            value: nvidia
          - name: CONTAINERD_SET_AS_DEFAULT
            value: "true"
  when: not enable_time_slicing

# see https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/latest/gpu-sharing.html#time-slicing-gpus-in-kubernetes
- name: Install NVIDIA GPU Operator with time slicing enabled
  kubernetes.core.helm:
    name: gpu-operator
    chart_ref: nvidia/gpu-operator
    chart_version: "{{ gpu_operator_chart_version | default('25.3.0') }}"
    release_namespace: "{{ gpu_operator_release }}"
    create_namespace: true
    values:
      driver:
        enabled: false
      nfd:
        enabled: "{{ enable_nfd }}"
      toolkit:
        env:
          - name: CONTAINERD_CONFIG
            value: /var/lib/rancher/rke2/agent/etc/containerd/config.toml.tmpl
          - name: CONTAINERD_SOCKET
            value: /run/k3s/containerd/containerd.sock
          - name: CONTAINERD_RUNTIME_CLASS
            value: nvidia
          - name: CONTAINERD_SET_AS_DEFAULT
            value: "true"
      devicePlugin:
        config:
          name: time-slicing-config-all
          default: any
  when: enable_time_slicing
